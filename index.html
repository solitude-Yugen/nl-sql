<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NL to SQL Converter</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        .header {
            background-color: #4CAF50;
            color: white;
            padding: 15px;
            text-align: center;
        }
        
        .navbar {
            background-color: #FFD580;
            padding: 10px;
            display: flex;
            align-items: center;
        }
        
        .folder-icon {
            margin-right: 15px;
            color: #1976D2;
            font-size: 1.5em;
        }
        
        .search-bar {
            flex-grow: 1;
            padding: 8px;
            border-radius: 15px;
            border: 1px solid #ccc;
            outline: none;
        }
        
        .main-container {
            display: flex;
            flex-grow: 1;
        }
        
        .project-directory {
            background-color: #607D8B;
            color: white;
            width: 20%;
            padding: 15px;
            display: flex;
            flex-direction: column;
        }
        
        .directory-header {
            background-color: #4CAF50;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 10px;
            text-align: center;
        }
        
        .workspace {
            display: flex;
            flex-direction: column;
            width: 80%;
        }
        
        .top-workspace {
            display: flex;
            height: 60%;
        }
        
        .sql-editor {
            background-color: #607D8B;
            padding: 15px;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }
        
        .editor-header {
            background-color: #4CAF50;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 10px;
            text-align: center;
        }
        
        .editor-content {
            flex-grow: 1;
            background-color: #f5f5f5;
            border-radius: 5px;
            padding: 10px;
            font-family: monospace;
            white-space: pre-wrap;
            overflow-y: auto;
        }
        
        .results-container {
            display: flex;
            flex-direction: column;
            width: 40%;
            background-color: #607D8B;
        }
        
        .result-table {
            background-color: #607D8B;
            padding: 15px;
            height: 60%;
            display: flex;
            flex-direction: column;
        }
        
        .error-log {
            background-color: #607D8B;
            padding: 15px;
            height: 40%;
            display: flex;
            flex-direction: column;
        }
        
        .log-header {
            background-color: #4CAF50;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 10px;
            text-align: center;
        }
        
        .log-content {
            flex-grow: 1;
            background-color: #f5f5f5;
            border-radius: 5px;
            padding: 10px;
            font-family: monospace;
            overflow-y: auto;
            color: red;
        }
        
        .table-content {
            flex-grow: 1;
            background-color: #f5f5f5;
            border-radius: 5px;
            padding: 10px;
            overflow-y: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        
        th {
            background-color: #f2f2f2;
        }
        
        .natural-lang-input {
            background-color: #607D8B;
            padding: 15px;
            height: 40%;
            display: flex;
            flex-direction: column;
        }
        
        .input-header {
            background-color: #4CAF50;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 10px;
            text-align: center;
        }
        
        textarea {
            flex-grow: 1;
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #ccc;
            resize: none;
            font-family: Arial, sans-serif;
            margin-bottom: 10px;
        }
        
        button {
            background-color: #4CAF50;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
        }
        
        button:hover {
            background-color: #45a049;
        }
    </style>
</head>
<body>
    <div class="header">
        <h2>NATURAL LANGUAGE TO SQL CONVERTER</h2>
    </div>
    
    <div class="navbar">
        <div class="folder-icon">üìÅ</div>
        <input type="text" class="search-bar" placeholder="Search...">
    </div>
    
    <div class="main-container">
        <div class="project-directory">
            <div class="directory-header">PROJECT DIRECTORY</div>
            <div>
                <ul id="database-list">
                    <li><a href="#" onclick="selectDatabase('default')">Default Database</a></li>
                </ul>
                <button onclick="createNewDatabase()">Add Database</button>
            </div>
        </div>
        
        <div class="workspace">
            <div class="top-workspace">
                <div class="sql-editor">
                    <div class="editor-header">SQL EDITOR</div>
                    <div class="editor-content" id="sql-output" contenteditable="true"></div>
                    <div style="margin-top: 10px; display: flex; justify-content: space-between;">
                        <button onclick="copyToClipboard()">Copy SQL</button>
                        <button onclick="executeSQL()">Execute SQL</button>
                    </div>
                </div>
                
                <div class="results-container">
                    <div class="result-table">
                        <div class="editor-header">RESULT/TABLE</div>
                        <div class="table-content" id="result-content">
                            <em>No results to display</em>
                        </div>
                    </div>
                    
                    <div class="error-log">
                        <div class="log-header">ERROR LOG</div>
                        <div class="log-content" id="error-content"></div>
                    </div>
                </div>
            </div>
            
            <div class="natural-lang-input">
                <div class="input-header">NATURAL LANG INPUT</div>
                <textarea id="nl-input" placeholder="Enter your query in natural language (e.g., 'Show me all customers from New York')"></textarea>
                <button onclick="convertToSQL()">Convert to SQL</button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/sql.js@1.8.0/dist/sql-wasm.js"></script>
    <script>
        // Global variables
        let db;
        let SQL;
        let currentDatabase = 'default';
        let databases = {
            'default': {
                name: 'Default Database',
                tables: {}
            }
        };

        // Initialize SQL.js
        initSqlJs({
            locateFile: file => `https://cdn.jsdelivr.net/npm/sql.js@1.8.0/dist/sql-wasm.wasm`
        }).then(function(sql) {
            SQL = sql;
            db = new SQL.Database();
            console.log("SQL.js initialized");
        }).catch(err => {
            document.getElementById('error-content').innerText = `Failed to load SQL.js: ${err.message}`;
        });

        // Function to create a new database
        function createNewDatabase() {
            const dbName = prompt("Enter database name:");
            if (dbName && !databases[dbName]) {
                databases[dbName] = {
                    name: dbName,
                    tables: {}
                };
                
                // Add to UI
                const dbList = document.getElementById('database-list');
                const li = document.createElement('li');
                li.innerHTML = `<a href="#" onclick="selectDatabase('${dbName}')">${dbName}</a>`;
                dbList.appendChild(li);
                
                // Select the new database
                selectDatabase(dbName);
            }
        }

        // Function to select a database
        function selectDatabase(dbName) {
            if (databases[dbName]) {
                currentDatabase = dbName;
                // Here you would typically load the database schema
                console.log(`Selected database: ${dbName}`);
            }
        }

        // Function to execute SQL
        function executeSQL() {
            const sqlQuery = document.getElementById('sql-output').innerText;
            if (!sqlQuery.trim()) {
                document.getElementById('error-content').innerText = "No SQL query to execute";
                return;
            }
            
            try {
                // Clear previous errors
                document.getElementById('error-content').innerText = "";
                
                // Execute the query
                const result = db.exec(sqlQuery);
                displayResults(result);
            } catch (error) {
                document.getElementById('error-content').innerText = error.message;
            }
        }

        // Function to display results
        function displayResults(results) {
            const resultContainer = document.getElementById('result-content');
            
            if (!results || results.length === 0) {
                resultContainer.innerHTML = "<em>Query executed successfully, but returned no results.</em>";
                return;
            }
            
            let tableHtml = "";
            
            results.forEach(result => {
                tableHtml += "<table>";
                
                // Table headers
                tableHtml += "<tr>";
                result.columns.forEach(column => {
                    tableHtml += `<th>${column}</th>`;
                });
                tableHtml += "</tr>";
                
                // Table rows
                result.values.forEach(row => {
                    tableHtml += "<tr>";
                    row.forEach(cell => {
                        tableHtml += `<td>${cell !== null ? cell : "NULL"}</td>`;
                    });
                    tableHtml += "</tr>";
                });
                
                tableHtml += "</table><br>";
            });
            
            resultContainer.innerHTML = tableHtml;
        }

        // Function to convert natural language to SQL
        async function convertToSQL() {
            const nlQuery = document.getElementById('nl-input').value.trim();
            if (!nlQuery) {
                document.getElementById('error-content').innerText = "Please enter a natural language query";
                return;
            }
            
            document.getElementById('error-content').innerText = "";
            
            try {
                // Using SQLCoder API via HuggingFace
                const response = await fetch("https://api-inference.huggingface.co/models/defog/sqlcoder-7b-2", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                        inputs: getSQLCoderPrompt(nlQuery),
                        parameters: {
                            max_new_tokens: 512,
                            temperature: 0.1
                        }
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`API error: ${response.status}`);
                }
                
                const result = await response.json();
                
                // Extract SQL from the response
                let sqlQuery = result[0].generated_text;
                
                // Clean up the SQL (remove any markdown formatting if present)
                sqlQuery = cleanupSQL(sqlQuery);
                
                // Display in editor
                document.getElementById('sql-output').innerText = sqlQuery;
            } catch (error) {
                document.getElementById('error-content').innerText = `Error converting to SQL: ${error.message}`;
            }
        }

        // Function to prepare prompt for SQLCoder
        function getSQLCoderPrompt(nlQuery) {
            // Get schema information from our databases object
            let schema = "";
            
            // In a real application, we would extract schema from the database
            // Here we're using a simplified example
            schema = `
CREATE TABLE customers (
    customer_id INT PRIMARY KEY,
    name VARCHAR(100),
    email VARCHAR(100),
    city VARCHAR(50),
    state VARCHAR(2)
);

CREATE TABLE products (
    product_id INT PRIMARY KEY,
    name VARCHAR(100),
    price DECIMAL(10, 2),
    category VARCHAR(50)
);

CREATE TABLE orders (
    order_id INT PRIMARY KEY,
    customer_id INT,
    order_date DATE,
    total DECIMAL(10, 2),
    FOREIGN KEY (customer_id) REFERENCES customers(customer_id)
);

CREATE TABLE order_items (
    item_id INT PRIMARY KEY,
    order_id INT,
    product_id INT,
    quantity INT,
    price DECIMAL(10, 2),
    FOREIGN KEY (order_id) REFERENCES orders(order_id),
    FOREIGN KEY (product_id) REFERENCES products(product_id)
);`;

            // Format the prompt for SQLCoder
            return `### Task
Generate a SQL query to answer the following question: ${nlQuery}

### Database Schema
${schema}

### Response
The SQL query to answer the question is:
`;
        }

        // Function to clean up SQL from potential markdown formatting
        function cleanupSQL(sqlText) {
            // Remove markdown code blocks if present
            sqlText = sqlText.replace(/```sql/g, '').replace(/```/g, '');
            
            // Trim extra whitespace
            return sqlText.trim();
        }

        // Function to copy SQL to clipboard
        function copyToClipboard() {
            const sqlText = document.getElementById('sql-output').innerText;
            if (!sqlText.trim()) {
                return;
            }
            
            navigator.clipboard.writeText(sqlText)
                .then(() => {
                    // Flash success message
                    const originalText = document.getElementById('sql-output').innerText;
                    document.getElementById('sql-output').innerText = "Copied to clipboard!";
                    setTimeout(() => {
                        document.getElementById('sql-output').innerText = originalText;
                    }, 1000);
                })
                .catch(err => {
                    document.getElementById('error-content').innerText = `Failed to copy: ${err.message}`;
                });
        }
    </script>
</body>
</html>